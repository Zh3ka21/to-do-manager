<!-- templates/partials/calendar_modal.html -->
<div id="calendar-modal" x-show="showCalendar" @click.away="showCalendar = false" class="calendar-modal">
    <div class="calendar-container">
        <div class="calendar-header">
            <button @click="previousMonth()">&lt;</button>
            <span x-text="currentMonthName"></span>
            <button @click="nextMonth()">&gt;</button>
        </div>
        <div class="calendar-grid">
            <div class="weekday" x-text="day" x-for="day in weekDays"></div>
            <template x-for="day in calendarDays">
                <div class="day" :class="{ 
                         'other-month': !day.currentMonth,
                         'has-project': hasProject(day.date),
                         'selected': isSelected(day.date)
                     }" @click="selectDate(day)" x-text="day.dayOfMonth">
                </div>
            </template>
        </div>
        <div class="calendar-footer" x-show="selectedDate">
            <input type="text" x-model="projectName" placeholder="Project name">
            <button @click="createProject()" :disabled="!canCreateProject">
                Create Project
            </button>
        </div>
    </div>
</div>

<!-- Add this to your main template -->
<style>
    .calendar-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .calendar-container {
        width: 300px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .weekday,
    .day {
        text-align: center;
        padding: 5px;
    }

    .day {
        cursor: pointer;
    }

    .day:hover {
        background: #f0f0f0;
    }

    .other-month {
        color: #999;
    }

    .has-project {
        background: #ffe6e6;
    }

    .selected {
        background: #e6f3ff;
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('calendar', () => ({
            showCalendar: false,
            currentDate: new Date(),
            selectedDate: null,
            projectName: '',
            weekDays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            existingProjects: [], // Will be populated from Django

            init() {
                // Fetch existing projects for the current month
                this.fetchExistingProjects();
            },

            get currentMonthName() {
                return this.currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            },

            get calendarDays() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];

                // Add previous month's days
                for (let i = firstDay.getDay(); i > 0; i--) {
                    const date = new Date(year, month, -i + 1);
                    days.push({
                        date: date.toISOString().split('T')[0],
                        dayOfMonth: date.getDate(),
                        currentMonth: false
                    });
                }

                // Add current month's days
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const date = new Date(year, month, i);
                    days.push({
                        date: date.toISOString().split('T')[0],
                        dayOfMonth: i,
                        currentMonth: true
                    });
                }

                return days;
            },

            previousMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1);
                this.fetchExistingProjects();
            },

            nextMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1);
                this.fetchExistingProjects();
            },

            selectDate(day) {
                this.selectedDate = day.date;
                this.projectName = `Project for ${day.date}`;
            },

            hasProject(date) {
                return this.existingProjects.includes(date);
            },

            isSelected(date) {
                return this.selectedDate === date;
            },

            async fetchExistingProjects() {
                const response = await fetch(`/api/projects/dates/?month=${this.currentDate.getMonth() + 1}&year=${this.currentDate.getFullYear()}`);
                if (response.ok) {
                    this.existingProjects = await response.json();
                }
            },

            async createProject() {
                if (!this.selectedDate || !this.projectName) return;

                const response = await fetch('/projects/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrf-token]').content
                    },
                    body: JSON.stringify({
                        date: this.selectedDate,
                        name: this.projectName
                    })
                });

                if (response.ok) {
                    const html = await response.text();
                    document.querySelector('.manager-container').innerHTML = html;
                    this.showCalendar = false;
                } else {
                    alert(await response.text());
                }
            }
        }));
    });
</script>


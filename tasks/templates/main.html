<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Task Manager{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/main_page_styles.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script src="https://unpkg.com/htmx.org@1.7.0"></script>
    {% csrf_token %}
</head>


<body hx-boost="true">
    <!-- Navbar -->
    <div class="nav-right">
        {% if user.is_authenticated %}
        <span class="welcome-message">Welcome, {{ user.username }}!</span>
        <a href="{% url 'account_logout' %}" class="btn logout-btn">Logout</a>
        {% else %}
        <a href="{% url 'account_login' %}" class="btn login-btn">Login</a>
        <a href="{% url 'account_signup' %}" class="btn signup-btn">Sign Up</a>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
    <div class="manager-container">
        <!-- Grid header:  Calendar Project Name Edit Delete -->
        <div class="grid-container">
            <div class="project-header">
                <div class="icon"><img src="{% static 'images/calendar.png' %}" alt="Calendar Icon" height="20"></div>
                <div>For Home </div>
            </div>
            <div></div>
            <div class="icons-right">
                <div class="icon"><img src="{% static 'images/pencil.png' %}" alt="Edit Icon" height="20"></div>
                <div class="icon"><img src="{% static 'images/delete.png' %}" alt="Delete Icon" height="20"></div>
            </div>
        </div>


        <!-- Grid 1 row: Input Add Task -->
        <div class="input-row">
            <form id="task-form" hx-post="{% url 'add_task' %}" hx-target="#task-list" hx-swap="beforeend"
                hx-trigger="submit" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                {% csrf_token %}
                <!-- TODO: Delete Hardcoded name -->
                <input type="hidden" name="project_name" value="For Home">
                <div class="unified-input">
                    <div class="input-icon">
                        <img src="{% static 'images/plus.png' %}" alt="Add Icon" height="20">
                    </div>
                    <input type="text" placeholder="Add new task..." id="new-task" name="task_name" required>

                    <!-- Time input with clock icon -->
                    <div class="input-icon">
                        <img src="{% static 'images/clock.png' %}" alt="Deadline Icon" height="20"
                            onclick="document.getElementById('deadline-time').showPicker();">
                    </div>
                    <input type="time" id="deadline-time" name="deadline_time">

                    <button type="submit">Add Task</button>
                </div>
            </form>
        </div>


        <!-- Grid 2 row: Dynamic part of different tasks -->
        <div id="task-list">
            {% if tasks %}
            {% for task in tasks %}
            <div class="task-grid" id="task-{{ task.id }}">
                <div class="task-content">
                    <input type="checkbox" hx-post="{% url 'toggle_task_done' task.id %}" hx-trigger="change"
                        hx-target="#task-{{ task.id }}" hx-swap="outerHTML" {% if task.is_done %} checked {% endif %}
                        hx-headers='{"X-CSRFToken": getCSRFToken()}'>

                        
                
                    <!-- Displayed Task Title -->
                    <div class="task-title" id="task-title-{{ task.id }}" {% if task.is_done %} style="text-decoration: line-through;"
                        {% endif %}>
                        {{ task.title }}
                    </div>
                
                    <!-- Hidden Input Field for Editing -->
                    <input type="text" class="edit-task-title" id="edit-task-input-{{ task.id }}" name="title" value="{{ task.title }}"
                        style="display: none;" hx-post="{% url 'edit_task' task.id %}"
                        hx-trigger="change, blur, keyup[key=='Enter'] from:#edit-task-input-{{ task.id }}" hx-target="#task-{{ task.id }}"
                        hx-swap="outerHTML">

                </div>

                <div></div>

                <div class="icons-right">
                    <div class="priority-controls">
                        <div class="icon">ðŸ”¼</div>
                        <div class="icon">ðŸ”½</div>
                    </div>

                    <div class="icon">
                        <img src="{% static 'images/pencil.png' %}" alt="Edit Icon" height="20" onclick="enableTaskEdit('{{ task.id }}')">
                    </div>


                    <div class="icon">
                        <img src="{% static 'images/delete.png' %}" alt="Delete Icon" height="20"
                            hx-post="{% url 'delete_task' task.id %}" hx-trigger="click" hx-target="#task-{{ task.id }}"
                            hx-swap="delete" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}


</body>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
    document.getElementById("task-form").addEventListener("htmx:afterRequest", function () {
            console.log("Form submitted, clearing inputs.");
            document.getElementById("new-task").value = "";
            document.getElementById("deadline-time").value = "";
        });

    document.body.addEventListener('htmx:configRequest', function (event) {
        event.detail.headers['X-CSRFToken'] = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    });

    function enableTaskEdit(taskId) {
            console.log("Editing Task ID:", taskId);  // Debugging line
            let titleElement = document.getElementById(`task-title-${taskId}`);
            let inputElement = document.getElementById(`edit-task-input-${taskId}`);

            if (!titleElement || !inputElement) {
                console.error("Elements not found for Task ID:", taskId);
                return;
            }

            titleElement.style.display = "none";
            inputElement.style.display = "block";
            inputElement.focus();
    }

    function getCSRFToken() {
        return document.cookie.split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
    }

    // Set CSRF token dynamically for all HTMX requests
    document.addEventListener("htmx:configRequest", (event) => {
        event.detail.headers['X-CSRFToken'] = getCSRFToken();
    });
</script>

</html>
